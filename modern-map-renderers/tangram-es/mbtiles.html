

<!DOCTYPE HTML>
<html lang="" >
    <head>
        <title>Offline MBTiles Support · The Outpost</title>
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.0.3">
        <meta name="keywords" content="Nick Hallahan,maps,GIS,Android,POSM,OpenMapKit,map renderers,Tangram">
        <meta name="author" content="Nicholas Hallahan">
        
        
    
    <link rel="stylesheet" href="../../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../../styles/website.css">
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="osm-xml-data-source.html" />
    
    
    <link rel="prev" href="./" />
    

        <link rel="shortcut icon" href="/images/favicon.png" type="image/png">
    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            <div class="site-heading">
                <div class="site-name">The Outpost</div>
                
                <div id="book-search-input" role="search">
                    <form id="search-form">
                        <input type="text" placeholder="Search The Outpost" />
                    </form>
                </div>
                
            </div>
            
                <nav role="navigation">
                


<ul class="summary">
    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../../">
            
                <a href="../../">
            
                    
                    Welcome
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="../../openmapkit/">
            
                <a href="../../openmapkit/">
            
                    
                    OpenMapKit
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="../../openmapkit/android.html">
            
                <a href="../../openmapkit/android.html">
            
                    
                    OpenMapKit Android
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="../../openmapkit/server.html">
            
                <a href="../../openmapkit/server.html">
            
                    
                    OpenMapKit Server
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="../../posm/">
            
                <a href="../../posm/">
            
                    
                    POSM
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="../../posm/story.html">
            
                <a href="../../posm/story.html">
            
                    
                    The Story
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="../../posm/hardware.html">
            
                <a href="../../posm/hardware.html">
            
                    
                    Hardware
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="../../posm/software.html">
            
                <a href="../../posm/software.html">
            
                    
                    Software
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="4.1" data-path="./">
            
                <a href="./">
            
                    
                    Tangram ES
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="4.1.1" data-path="mbtiles.html">
            
                <a href="mbtiles.html">
            
                    
                    Offline MBTiles Support
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="osm-xml-data-source.html">
            
                <a href="osm-xml-data-source.html">
            
                    
                    OSM XML Data Source
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="installation.html">
            
                <a href="installation.html">
            
                    
                    Android Installation
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="jni.html">
            
                <a href="jni.html">
            
                    
                    Android JNI Bridge
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="tangram-android-sdk.html">
            
                <a href="tangram-android-sdk.html">
            
                    
                    Tangram Android SDK
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6" data-path="notes-tips-and-tricks.html">
            
                <a href="notes-tips-and-tricks.html">
            
                    
                    Notes, Tips and Tricks
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="5.1" data-path="../../leaflet/">
            
                <a href="../../leaflet/">
            
                    
                    Leaflet Plugins
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="6.1" data-path="../../resume/">
            
                <a href="../../resume/">
            
                    
                    Résumé
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="7.1" data-path="../../wiki/">
            
                <a href="../../wiki/">
            
                    
                    Wiki
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../.." >Offline MBTiles Support</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
                            <div id="book-search-results">
                                <div class="search-noresults">
                                    <section class="normal markdown-section">
                                    
                                    <h1 id="tangram-offline-mbtiles-support">Tangram Offline MBTiles Support</h1>
<p><em>Fri Nov 4 2016</em></p>
<figure style="float:right;"><img src="https://cloud.githubusercontent.com/assets/556367/18572461/8bd645f2-7b70-11e6-80e5-477bb826cb4b.png" alt="Offline MBTiles" style="max-width:275px;"><figcaption style="text-align:center;font-style:italic;">Figure: Offline MBTiles Rendering on Android</figcaption></figure>

<p>Any time you are in a remote area with your mobile device, you may not have access to the internet. In this situation, your mapping library needs to be able to store it&apos;s data offline, on the device. We chose the MBTiles format to store our tiles offline.</p>
<p>MBTiles is a <a href="https://github.com/mapbox/mbtiles-spec" _target="blank">specification</a> that has been maintained since 2011, primarily as a tile storage and transport container. Because it is a widely used method to store tiles, both vector and image, it is only logical to continue using this schema to store vector tiles offline.</p>
<p>The spec itself describes the SQLite database schema that is required for the file to be considered MBTiles. Right now the spec only describes the contents of a tile to be <code>png</code> or <code>jpg</code>. However, there is an <a href="https://github.com/mapbox/mbtiles-spec/pull/46" _target="blank">open pull request</a> that allows you to specify the MIME type of the data you are packaging. This means that you can now store formats like GeoJSON, TopoJSON, Mapbox Vector Tiles, as well as others, as long as there is a corresponding MIME type. In addition, there will be a compression field in the MBTiles metadata table that declares the codec in which tile contents may be compressed.</p>
<p>In the wild, you can find MBTiles storing vector tiles in several places. The most notable example is <a href="http://osm2vectortiles.org/" _target="blank">osm2vectortiles.org</a>. Mapzen has since <a href="https://github.com/tangrams/tangram-es/pull/1015" _target="blank">merged</a> my MBTiles work and plans on releasing MBTile packs to go along with the functionality in their Metro Extracts sometime during Q4 2016.</p>
<h1 id="mbtiles-support-code-sprint">MBTiles Support Code Sprint</h1>
<p>My code sprint allows you to use MBTiles in two key ways: 1) as a tile store and transport mechanism, and 2) as a cache. You can find this sprint documented as a <a href="https://github.com/tangrams/tangram-es/pull/982" _target="blank">pull request</a> on the Tangram ES Github. This code has been <a href="https://github.com/tangrams/tangram-es/pull/1015" _target="blank">merged</a> into <a href="https://github.com/hjanetzek" _target="blank">Hannes Janetzek</a>&apos;s branch where he is further refining the concept of data sources and tile sources in the library at large.</p>
<h2 id="scene-declaration">Scene Declaration</h2>
<p>You can declare a data source to have an <code>mbtiles</code> file path both programmatically and via your <code>scene.yaml</code>. </p>
<p>If you want to add tiles to your cache online, you can put both a <code>url</code> and <code>mbtiles</code> in your data source, and http tile requests will be written to your MBTiles db. If the MBTiles file does not exist, Tangram ES will attempt to create a fresh MBTiles file all set up with the proper schema at that path given.</p>
<pre><code class="lang-yaml"><span class="hljs-attr">sources:</span>
<span class="hljs-attr">    osm:</span>
<span class="hljs-attr">        type:</span> GeoJSON
<span class="hljs-attr">        url:</span>  https://vector.mapzen.com/osm/all/{z}/{x}/{y}.json
<span class="hljs-attr">        mbtiles:</span> /Users/njh/osm-data/mbtiles/winters-mapzen-geojson.mbtiles
<span class="hljs-attr">        max_zoom:</span> <span class="hljs-number">16</span>
<span class="hljs-attr">        url_params:</span>
<span class="hljs-attr">            api_key:</span> vector-tiles-tyHL4AY
</code></pre>
<p>You don&apos;t need a URL, however. You can have your data source simply fetch tiles from the MBTiles and not request anything from the network. </p>
<pre><code class="lang-yaml"><span class="hljs-attr">sources:</span>
<span class="hljs-attr">    osm:</span>
<span class="hljs-attr">        type:</span> GeoJSON
<span class="hljs-attr">        mbtiles:</span> /Users/njh/osm-data/mbtiles/winters-mapzen-geojson.mbtiles
<span class="hljs-attr">        max_zoom:</span> <span class="hljs-number">16</span>
</code></pre>
<p>This works nicely when you have full knowledge and access to your filesystem. On Android, however, you might need to get a file path to your MBTiles programmatically first.</p>
<pre><code class="lang-java">File storageDir = Environment.getExternalStorageDirectory();
File mbtilesFile = <span class="hljs-keyword">new</span> File(storageDir, <span class="hljs-string">&quot;tangram-geojson-cache.mbtiles&quot;</span>);
map.setMBTiles(<span class="hljs-string">&quot;osm&quot;</span>, mbtilesFile);
</code></pre>
<p>This would set the file <code>tangram-geojson-cache.mbtiles</code> to be your MBTiles in the <code>osm</code> datasource. It will use a URL from your <code>scene.yaml</code> to populate your cache just like before (or not). Similarly, <code>Map::setMBTiles</code> is <a href="https://github.com/hallahan/tangram-es/blob/8232af10e4c7ccc5582f790d6eeee29046d8d04e/core/src/tangram.cpp#L252-L256" _target="blank">exposed from the native</a> C++ <code>Map</code> interface as well. We will also want to add Objective C bindings.</p>
<h2 id="mbtiles-spec">MBTiles Spec</h2>
<p>The MBTiles database schema is built to adhere to <a href="https://github.com/pnorman" _target="blank">Paul Norman</a>&apos;s <a href="https://github.com/pnorman/mbtiles-spec/blob/2.0/2.0/spec.md" _target="blank">MBTiles 2.0 specification</a>. The metadata table is <a href="https://github.com/hallahan/tangram-es/blob/8232af10e4c7ccc5582f790d6eeee29046d8d04e/core/src/util/mbtiles.h#L144-L175" _target="blank">being populated with the required values</a> declared. In addition to adhering to the spec itself, I&apos;m also creating MBTiles databases with <a href="https://github.com/mapbox/node-mbtiles/blob/4bbfaf991969ce01c31b95184c4f6d5485f717c3/lib/schema.sql" _target="blank">identical schema</a> to the most widely used reference implementation, node-mbtiles. You can see the creation of the database in <a href="https://github.com/hallahan/tangram-es/blob/8232af10e4c7ccc5582f790d6eeee29046d8d04e/core/src/util/mbtiles.h" _target="blank">mbtiles.h</a>. One addition that I&apos;d like to make is that we check the <code>metadata</code> table and make sure that the data format is consistent with what we have declared in our <code>scene.yaml</code>. </p>
<h2 id="sqlitecpp">SQLiteCpp</h2>
<p>I&apos;m quite happy with the use of <a href="https://github.com/SRombauts/SQLiteCpp" _target="blank">SQLiteCpp</a> C++ SQLite3 wrapper library. It integrates easily with the CMake build process. It works without any issue on Mac OS X and Android, and it&apos;s usage is part of the core library. One thing that sets this MBTiles implementation apart from the others is that it is done in the core C++ library. We do not re-invent the wheel and re-implement for Android, iOS, etc.</p>
<h2 id="md5-checksum-hash">MD5 Checksum Hash</h2>
<p>One clever feature found in <code>node-mbtiles</code> that is not mentioned in the spec is that the underlying database schema has a <code>map</code> and <code>images</code> table that are joined to get you your tile data. The key that joins these tables is an MD5 checksum of the actual tile data. If you have many tiles with duplicate or empty data structures, rather than having a repeat entry in the images table, the checksum will join you to a single entry in <code>images</code> to all of the tiles pointing to that same data.</p>
<p>Rather than integrating a big encryption library like OpenSSL, I just wanted the MD5 function. So, after a bit of searching, I found a C++ hash library that was built to be portable and easy to integrate. I was able to bring in only the MD5 function, therefore saving us from adding extra clutter to the code base. I have a <a href="https://github.com/hallahan/tangram-es/blob/8232af10e4c7ccc5582f790d6eeee29046d8d04e/core/include/hash-library/README.md" _target="blank">readme</a> that goes into greater detail. I did manually test the hash values with several other MD5 generators and found that the output values matched with the same input.</p>
<h2 id="mbtiles-tile-task">MBTiles Tile Task</h2>
<p>You&apos;ll notice that reads and writes to the database are being done inside of an <a href="https://github.com/hallahan/tangram-es/blob/8232af10e4c7ccc5582f790d6eeee29046d8d04e/core/src/tile/mbtilesTileTask.h" _target="blank">MBTilesTileTask</a>. This class is a subclass of <code>DownloadTileTask</code>, and it is run a tile worker thread, so we can do our blocking call to the database without trouble.</p>
<p>This will work a bit differently when the MBTiles feature is finally released, because the general functionality of tile tasks is going through some changes.</p>
<h1 id="example-app">Example App</h1>
<p>Stay tuned to the progress of this feature. Once Mapzen releases Metro Extract MBTiles packs, I will create an Android app that lets you download and select an MBTiles file.</p>

                                    
                                    </section>
                                </div>
                                <div class="search-results">
                                    <div class="has-results">
                                        
                                        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
                                        <ul class="search-results-list"></ul>
                                        
                                    </div>
                                    <div class="no-results">
                                        
                                        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
                                        
                                    </div>
                                </div>
                            </div>
                            
                        </div>
                    </div>
                
            </div>

            
                
                <a href="./" class="navigation navigation-prev " aria-label="Previous page: Tangram ES">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="osm-xml-data-source.html" class="navigation navigation-next " aria-label="Next page: OSM XML Data Source">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        // fix for detecting taps on book body for mobile and narrow screen
        function mobileSidebarCloseFix() {
            function checkToToggle(e) {
                if ($(window).width() <= 600 
                        && e.target.tagName !== 'I'
                        && e.target.tagName !== 'A'
                        && gitbook.sidebar.isOpen()) {
                    gitbook.sidebar.toggle();
                }
            }
            $bookbody = $('.book-body');
            $bookbody.click(function(e) {
                checkToToggle(e);
            });
            $bookbody.on('touchend', function(e) {
                checkToToggle(e);
            });
        }

        // make keyboard disappear when pressing go or enter when typing
        // in search input. fix for mobile behavior.
        function searchInputMobileFix() {
            $('#search-form').submit(function(e) {
                e.preventDefault();
                if(document.activeElement) {
                    document.activeElement.blur();
                    if ($(window).width() <= 600 && gitbook.sidebar.isOpen()) {
                        gitbook.sidebar.toggle();
                    }
                }
            });
        }

        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"Offline MBTiles Support","level":"4.1.1","depth":2,"next":{"title":"OSM XML Data Source","level":"4.1.2","depth":2,"path":"modern-map-renderers/tangram-es/osm-xml-data-source.md","ref":"modern-map-renderers/tangram-es/osm-xml-data-source.md","articles":[]},"previous":{"title":"Tangram ES","level":"4.1","depth":1,"path":"modern-map-renderers/tangram-es/index.md","ref":"modern-map-renderers/tangram-es/index.md","articles":[{"title":"Offline MBTiles Support","level":"4.1.1","depth":2,"path":"modern-map-renderers/tangram-es/mbtiles.md","ref":"modern-map-renderers/tangram-es/mbtiles.md","articles":[]},{"title":"OSM XML Data Source","level":"4.1.2","depth":2,"path":"modern-map-renderers/tangram-es/osm-xml-data-source.md","ref":"modern-map-renderers/tangram-es/osm-xml-data-source.md","articles":[]},{"title":"Android Installation","level":"4.1.3","depth":2,"path":"modern-map-renderers/tangram-es/installation.md","ref":"modern-map-renderers/tangram-es/installation.md","articles":[]},{"title":"Android JNI Bridge","level":"4.1.4","depth":2,"path":"modern-map-renderers/tangram-es/jni.md","ref":"modern-map-renderers/tangram-es/jni.md","articles":[]},{"title":"Tangram Android SDK","level":"4.1.5","depth":2,"path":"modern-map-renderers/tangram-es/tangram-android-sdk.md","ref":"modern-map-renderers/tangram-es/tangram-android-sdk.md","articles":[]},{"title":"Notes, Tips and Tricks","level":"4.1.6","depth":2,"path":"modern-map-renderers/tangram-es/notes-tips-and-tricks.md","ref":"modern-map-renderers/tangram-es/notes-tips-and-tricks.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["expandable-chapters","anchorjs"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"fontsettings":{"theme":"white","family":"serif","size":2},"expandable-chapters":{},"anchorjs":{},"highlight":{},"search":{},"lunr":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false}},"theme":"default","author":"Nicholas Hallahan","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"gitbook":"*"},"file":{"path":"modern-map-renderers/tangram-es/mbtiles.md","mtime":"2016-11-05T02:59:05.000Z","type":"markdown"},"gitbook":{"version":"3.0.3","time":"2016-11-05T02:59:40.537Z"},"basePath":"../..","book":{"language":""}});
            mobileSidebarCloseFix();
            searchInputMobileFix();
        });
    </script>
</div>

        
    <script src="../../gitbook/gitbook.js"></script>
    <script src="../../gitbook/theme.js"></script>
    
        
        <script src="../../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="https://cdnjs.cloudflare.com/ajax/libs/anchor-js/3.1.1/anchor.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-anchorjs/anchor-style.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="../../gitbook/gitbook-plugin-fontsettings/buttons.js"></script>
        
    

    </body>
</html>
